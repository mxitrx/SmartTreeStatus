#include <WiFi.h>
#include <WebServer.h>
#include <HTTPClient.h>
#include <WiFiClientSecure.h>
#include <WiFiUdp.h>
#include <NTPClient.h> 
#include "DHT.h"
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ================= CONFIGURATION =================
const char* ssid = "iPhone MIX";
const char* password = "01020304";

// LINE Token ‡πÅ‡∏•‡∏∞ UserID
const char* lineToken = "KAzJW1Zhn/w7IPcne5OwWmpY2TtGluUE7RiybnNcnuvAML/qQHuRMW6Nb+f6/skYu0cUubL7ze1IDvzjVB6PaSqTQubxmjPi9kc6ejcjeS+1yx9zbskzihWDOG62PgZI7NhFQvKncyrsFf5OzEnVTgdB04t89/1O/w1cDnyilFU="; 
const char* lineUserId = "C023eca7df493bd62cbc40efe64e9a524";            

const int REPORT_HOUR = 8; // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (8 ‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤)

const int soilPin = 34;
const int dhtPin = 27;
const int relayPin = 16;

// *** ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Relay (Active LOW: LOW=‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, HIGH=‡∏´‡∏¢‡∏∏‡∏î) ***
#define PUMP_ON  LOW   
#define PUMP_OFF HIGH

#define DHTTYPE DHT11
const int dryValue = 3500; 
const int wetValue = 1500; 

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Address LCD (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 0x27 ‡∏´‡∏£‡∏∑‡∏≠ 0x3F)
LiquidCrystal_I2C lcd(0x27, 16, 2); 
// =================================================

DHT dht(dhtPin, DHTTYPE);
WebServer server(80);
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", 7*3600); // GMT+7 Bangkok

bool reportSentToday = false;
unsigned long lastLCDUpdate = 0;

bool isAutoMode = true; 
bool manualPumpState = false; 

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô
int getSoilPercent() {
  int val = analogRead(soilPin);
  int percent = map(val, dryValue, wetValue, 0, 100);
  return constrain(percent, 0, 100);
}

// Logic ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏±‡πä‡∏°
String processPumpLogic(int moisture) {
  String statusStr = "OFF";
  bool isRelayActive = (digitalRead(relayPin) == PUMP_ON);

  if (isAutoMode) {
    if (moisture < 30) {
      digitalWrite(relayPin, PUMP_ON);
      statusStr = "AUTO:ON";
    } else if (moisture > 40) {
      digitalWrite(relayPin, PUMP_OFF);
      statusStr = "AUTO:OFF";
    } else {
      statusStr = isRelayActive ? "AUTO:ON" : "AUTO:OFF";
    }
  } else {
    if (manualPumpState) {
       digitalWrite(relayPin, PUMP_ON);
       statusStr = "MANU:ON";
    } else {
       digitalWrite(relayPin, PUMP_OFF);
       statusStr = "MANU:OFF";
    }
  }
  return statusStr;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ LCD (‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
void updateLCD(int s, float t, float h) {
  if (millis() - lastLCDUpdate > 10000) { 
    lastLCDUpdate = millis();
    processPumpLogic(s); 
    
    String timeStr = timeClient.getFormattedTime();
    String shortTime = timeStr.substring(0, 5); 
    bool isWorking = (digitalRead(relayPin) == PUMP_ON);

    static int screenState = 0;

    lcd.clear();

    if (screenState == 0) {
      lcd.setCursor(0, 0);
      lcd.print("Soil:"); lcd.print(s); lcd.print("% ");
      if (s < 30) lcd.print("[DRY]");
      else if (s > 70) lcd.print("[WET]");
      else lcd.print("[OK] ");

      lcd.setCursor(0, 1);
      lcd.print("T:"); lcd.print((int)t); lcd.print("C  ");
      lcd.print("H:"); lcd.print((int)h); lcd.print("%");
    } 
    else if (screenState == 1) {
      lcd.setCursor(0, 0);
      lcd.print("Pump: ");
      lcd.print(isWorking ? "ON  " : "OFF ");
      lcd.print(isAutoMode ? "AUTO" : "MANU");

      lcd.setCursor(0, 1);
      lcd.print("Time: ");
      lcd.print(shortTime);
    }
    else if (screenState == 2) {
      lcd.setCursor(0, 0);
      if (WiFi.status() == WL_CONNECTED) {
        lcd.print("WiFi: Connected");
        lcd.setCursor(0, 1);
        lcd.print(WiFi.localIP().toString());
      } else {
        lcd.print("WiFi: Lost!");
        lcd.setCursor(0, 1);
        lcd.print("Reconnecting...");
      }
    }

    screenState++;
    if (screenState > 2) {
      screenState = 0;
    }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á Line
void sendDailyReport(int moisture, float temp, float hum) {
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClientSecure client;
    client.setInsecure();
    HTTPClient https;
    String statusColor = (moisture < 30) ? "#ff3333" : (moisture < 70) ? "#00cc66" : "#3399ff";
    String statusText = (moisture < 30) ? "‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏î‡∏ô‡πâ‡∏≥!" : (moisture < 70) ? "‡∏î‡∏¥‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å" : "‡∏î‡∏¥‡∏ô‡πÅ‡∏â‡∏∞‡πÑ‡∏õ";
    String timeStr = timeClient.getFormattedTime();

    String json = "{\"to\":\"" + String(lineUserId) + "\",\"messages\":[{\"type\":\"flex\",\"altText\":\"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô\",\"contents\":{\"type\":\"bubble\",\"styles\":{\"body\":{\"backgroundColor\":\"#1a1a1a\"}},\"body\":{\"type\":\"box\",\"layout\":\"vertical\",\"contents\":[{\"type\":\"text\",\"text\":\"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô\",\"weight\":\"bold\",\"color\":\"#00cc66\",\"size\":\"xs\"},{\"type\":\"text\",\"text\":\"‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ\",\"weight\":\"bold\",\"size\":\"xl\",\"color\":\"#ffffff\",\"margin\":\"md\"},{\"type\":\"text\",\"text\":\"‡πÄ‡∏ß‡∏•‡∏≤: " + timeStr + "\",\"size\":\"xs\",\"color\":\"#aaaaaa\",\"margin\":\"xs\"},{\"type\":\"separator\",\"margin\":\"xl\",\"color\":\"#333333\"},{\"type\":\"box\",\"layout\":\"vertical\",\"margin\":\"xl\",\"contents\":[{\"type\":\"text\",\"text\":\"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô\",\"color\":\"#aaaaaa\",\"size\":\"sm\"},{\"type\":\"text\",\"text\":\"" + String(moisture) + "%\",\"color\":\"" + statusColor + "\",\"size\":\"4xl\",\"weight\":\"bold\",\"align\":\"center\",\"margin\":\"md\"},{\"type\":\"text\",\"text\":\"" + statusText + "\",\"color\":\"" + statusColor + "\",\"size\":\"sm\",\"align\":\"center\"}]},{\"type\":\"box\",\"layout\":\"horizontal\",\"margin\":\"xxl\",\"spacing\":\"md\",\"contents\":[{\"type\":\"box\",\"layout\":\"vertical\",\"backgroundColor\":\"#333333\",\"cornerRadius\":\"5px\",\"paddingAll\":\"10px\",\"contents\":[{\"type\":\"text\",\"text\":\"‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥\",\"color\":\"#aaaaaa\",\"size\":\"xs\",\"align\":\"center\"},{\"type\":\"text\",\"text\":\"" + String(temp, 1) + "¬∞\",\"color\":\"#ffffff\",\"weight\":\"bold\",\"size\":\"xl\",\"align\":\"center\"}]},{\"type\":\"box\",\"layout\":\"vertical\",\"backgroundColor\":\"#333333\",\"cornerRadius\":\"5px\",\"paddingAll\":\"10px\",\"contents\":[{\"type\":\"text\",\"text\":\"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®\",\"color\":\"#aaaaaa\",\"size\":\"xs\",\"align\":\"center\"},{\"type\":\"text\",\"text\":\"" + String(hum, 1) + "%\",\"color\":\"#ffffff\",\"weight\":\"bold\",\"size\":\"xl\",\"align\":\"center\"}]}]}]}}}]}";

    if (https.begin(client, "https://api.line.me/v2/bot/message/push")) {
      https.addHeader("Content-Type", "application/json");
      https.addHeader("Authorization", "Bearer " + String(lineToken));
      int httpResponseCode = https.POST(json);
      Serial.print("Line Sent, Code: "); Serial.println(httpResponseCode);
      https.end();
    }
  }
}

// Web Handler: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î/‡∏õ‡∏±‡πä‡∏°
void handleSetControl() {
  if (server.hasArg("mode")) {
    String m = server.arg("mode");
    isAutoMode = (m == "auto");
  }
  if (server.hasArg("pump")) {
    String p = server.arg("pump");
    manualPumpState = (p == "on");
    if (manualPumpState) isAutoMode = false;
  }
  server.send(200, "text/plain", "OK");
}

// Web Handler: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Sensor (API)
void handleGetSensor() {
  int s = getSoilPercent();
  float t = dht.readTemperature();
  float h = dht.readHumidity();
  if (isnan(t)) t = 0; if (isnan(h)) h = 0;
  
  bool isWorking = (digitalRead(relayPin) == PUMP_ON);

  String json = "{\"soil\":" + String(s) + 
                ",\"temp\":" + String(t) + 
                ",\"hum\":" + String(h) + 
                ",\"pump\":" + String(isWorking ? 1 : 0) + 
                ",\"isAuto\":" + String(isAutoMode ? "true" : "false") + 
                ",\"time\":\"" + timeClient.getFormattedTime() + "\"}"; 
  server.send(200, "application/json", json);
}

// Web Handler: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå
void handleTestLine() {
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  int s = getSoilPercent();
  sendDailyReport(s, t, h);
  server.send(200, "text/plain", "OK");
}

// Web Handler: ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å (Clean & Simple UI)
void handleRoot() {
  String html = R"rawliteral(
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="theme-color" content="#0f766e">
<title>Smart Farm Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --green: #10b981;
    --red: #ef4444;
    --blue: #3b82f6;
    --line: #00c300;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Kanit', sans-serif;
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏£‡∏Å‡∏ï - ‡∏ü‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏• (Emerald & Teal) */
    background: linear-gradient(135deg, #020617, #0f766e, #064e3b);
    background-size: 200% 200%;
    animation: gradientShift 10s ease infinite;
    display: flex; justify-content: center; align-items: flex-start;
    padding: 20px; color: #fff; min-height: 100vh;
  }
  @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

  .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 16px; margin-top: 10px; }

  .card {
    background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 24px; padding: 24px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
  .title { font-size: 22px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .clock { background: rgba(0,0,0,0.3); padding: 6px 16px; border-radius: 20px; font-family: 'Roboto Mono', monospace; font-size: 14px; border: 1px solid rgba(255,255,255,0.05); }

  /* Soil Section */
  .soil-wrap { text-align: center; }
  .soil-label { font-size: 15px; color: rgba(255,255,255,0.7); margin-bottom: -5px; }
  .soil-value { font-size: 72px; font-weight: 700; font-family: 'Roboto Mono', monospace; line-height: 1.2; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  .unit { font-size: 24px; color: rgba(255,255,255,0.6); font-family: 'Kanit'; }
  
  .progress { height: 12px; background: rgba(0,0,0,0.3); border-radius: 20px; margin: 15px 0 20px 0; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
  .progress-bar { height: 100%; width: 0%; border-radius: 20px; transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
  
  .status { display: inline-block; padding: 6px 20px; border-radius: 20px; font-size: 15px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: background 0.4s; }

  /* Grid Mini Cards */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0; background: transparent; border: none; box-shadow: none; backdrop-filter: none; animation: none;}
  .mini { background: rgba(255,255,255,0.08); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  .mini h3 { margin: 0; font-size: 14px; color: rgba(255,255,255,0.7); font-weight: 500; }
  .mini p { margin: 8px 0 0; font-size: 28px; font-weight: 700; font-family: 'Roboto Mono', monospace; }
  .mini span.u { font-size: 16px; color: rgba(255,255,255,0.6); font-family: 'Kanit'; }

  /* Controls */
  .control-label { font-size: 15px; color: rgba(255,255,255,0.8); margin-bottom: 12px; font-weight: 500; }
  .segment { display: flex; background: rgba(0,0,0,0.3); border-radius: 16px; padding: 6px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
  .btn-mode { flex: 1; padding: 12px; border: none; background: transparent; color: rgba(255,255,255,0.6); border-radius: 12px; font-family: 'Kanit'; font-size: 15px; font-weight: 500; cursor: pointer; transition: 0.3s; }
  .btn-mode.active { background: rgba(255,255,255,0.2); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); font-weight: 600; }
  
  button { width: 100%; padding: 16px; border: none; border-radius: 16px; font-family: 'Kanit'; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; color: #fff; }
  button:active { transform: scale(0.97); }
  
  .btn-pump { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); }
  .btn-pump:disabled { opacity: 0.6; cursor: not-allowed; }
  
  .btn-line { background: var(--line); box-shadow: 0 6px 15px rgba(0, 195, 0, 0.3); margin-top: 5px; }
  .btn-line:hover { background: #00d400; box-shadow: 0 8px 20px rgba(0, 195, 0, 0.4); }

  .footer { text-align: center; font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 10px; }
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="title">üå± Smart Tree Status</div>
    <div class="clock" id="clockVal">--:--</div>
  </div>

  <div class="card soil-wrap">
    <div class="soil-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
    <div class="soil-value"><span id="soilVal">--</span><span class="unit">%</span></div>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="status" id="statusText" style="background: rgba(255,255,255,0.1);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
  </div>

  <div class="grid">
    <div class="mini">
      <h3>üå° ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h3>
      <p><span id="tempVal">--</span><span class="u">¬∞C</span></p>
    </div>
    <div class="mini">
      <h3>üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
      <p><span id="humVal">--</span><span class="u">%</span></p>
    </div>
  </div>

  <div class="card">
    <div class="control-label">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥</div>
    <div class="segment">
      <button class="btn-mode active" id="btnAuto" onclick="setMode('auto')">‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
      <button class="btn-mode" id="btnManual" onclick="setMode('manual')">‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á</button>
    </div>
    <button class="btn-pump" id="btnPump" onclick="togglePump()">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏±‡πä‡∏°</button>
  </div>

  <button class="btn-line" id="btnLine" onclick="triggerTest()">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ LINE üí¨</button>
  <div class="footer">Real-time IoT Monitoring System</div>

</div>

<script>
let currentIsAuto = true;
let currentPumpState = false;

function setMode(mode) {
  fetch('/set-control?mode='+mode).then(()=>updateData());
}

function togglePump() {
  if(currentIsAuto) return;
  let state = !currentPumpState ? 'on' : 'off';
  fetch('/set-control?mode=manual&pump='+state).then(()=>updateData());
}

function triggerTest() {
  let btn = document.getElementById('btnLine');
  let originalText = btn.innerHTML;
  btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
  btn.style.opacity = '0.7';
  fetch('/test-line').then(() => {
     btn.innerHTML = '‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
     setTimeout(() => { btn.innerHTML = originalText; btn.style.opacity = '1'; }, 2000);
  });
}

function updateData() {
  fetch('/get-sensor')
  .then(r=>r.json())
  .then(data=>{
    document.getElementById('soilVal').innerText = data.soil;
    document.getElementById('tempVal').innerText = data.temp.toFixed(1);
    document.getElementById('humVal').innerText = data.hum.toFixed(1);

    let timeParts = data.time.split(':');
    document.getElementById('clockVal').innerText = timeParts[0] + ':' + timeParts[1];

    let bar = document.getElementById('progressBar');
    let status = document.getElementById('statusText');
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ñ‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏µ
    bar.style.width = data.soil + "%";
    
    let color = "#10b981"; // ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏ß‡πà‡∏≤‡∏á)
    let text = "‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ üåø";
    
    if (data.soil < 30) {
      color = "#ef4444"; // ‡πÅ‡∏´‡πâ‡∏á (‡πÅ‡∏î‡∏á)
      text = "‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á (‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) üíß";
    } else if (data.soil > 70) {
      color = "#3b82f6"; // ‡πÅ‡∏â‡∏∞ (‡∏ü‡πâ‡∏≤)
      text = "‡∏î‡∏¥‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏π‡∏á üåßÔ∏è";
    }

    bar.style.background = color;
    status.style.background = color + "CC"; 
    status.innerText = text;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î
    currentIsAuto = data.isAuto;
    currentPumpState = (data.pump == 1);

    let btnAuto = document.getElementById('btnAuto');
    let btnManual = document.getElementById('btnManual');
    let btnPump = document.getElementById('btnPump');

    if(currentIsAuto) {
      btnAuto.classList.add('active');
      btnManual.classList.remove('active');
      
      btnPump.disabled = true;
      btnPump.style.background = currentPumpState ? "rgba(239, 68, 68, 0.6)" : "rgba(255,255,255,0.1)";
      btnPump.style.borderColor = "transparent";
      btnPump.innerText = currentPumpState ? "‡∏õ‡∏±‡πä‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏≠‡∏≠‡πÇ‡∏ï‡πâ)" : "‡∏õ‡∏±‡πä‡∏°‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏≠‡∏≠‡πÇ‡∏ï‡πâ)";
    } else {
      btnAuto.classList.remove('active');
      btnManual.classList.add('active');
      
      btnPump.disabled = false;
      btnPump.style.background = currentPumpState ? "#ef4444" : "#3b82f6";
      btnPump.style.borderColor = "transparent";
      btnPump.innerText = currentPumpState ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°" : "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°";
      btnPump.style.boxShadow = currentPumpState ? "0 4px 15px rgba(239, 68, 68, 0.4)" : "0 4px 15px rgba(59, 130, 246, 0.4)";
    }
  })
  .catch(err => console.error("Error updating:", err));
}

setInterval(updateData, 1000);
updateData();
</script>
</body>
</html>
)rawliteral";

  server.send(200, "text/html", html);
}

// ================= SETUP =================
void setup() {
  Serial.begin(115200);
  pinMode(soilPin, INPUT);
  pinMode(relayPin, OUTPUT);
  digitalWrite(relayPin, PUMP_OFF); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°‡∏Å‡πà‡∏≠‡∏ô

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° LCD
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0); lcd.print("Smart Farm");
  lcd.setCursor(0, 1); lcd.print("WiFi Connecting");

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° Sensor & WiFi
  dht.begin();
  WiFi.begin(ssid, password);
  
  int counter = 0;
  while (WiFi.status() != WL_CONNECTED) { 
    delay(500); 
    Serial.print(".");
    if(counter > 20) { ESP.restart(); } // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    counter++;
  }
  Serial.println("\nWiFi Connected: " + WiFi.localIP().toString());
  
  // ‡πÅ‡∏à‡πâ‡∏á‡∏ö‡∏ô LCD
  lcd.setCursor(0, 1); lcd.print("WiFi: OK       ");
  delay(1000);
  lcd.clear();

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° NTP & Server
  timeClient.begin(); 
  
  server.on("/", handleRoot);            
  server.on("/get-sensor", handleGetSensor); 
  server.on("/test-line", handleTestLine);   
  server.on("/set-control", handleSetControl);
  
  server.begin();
}

// ================= LOOP =================
void loop() {
  server.handleClient();
  timeClient.update(); 

  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Sensor
  float h = dht.readHumidity();
  float t = dht.readTemperature();
  int s = getSoilPercent();

  // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏õ‡∏±‡πä‡∏° ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≠
  processPumpLogic(s);
  updateLCD(s, t, h);

  // ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 8 ‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤
  int currentHour = timeClient.getHours();
  int currentMinute = timeClient.getMinutes();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô)
  if (currentHour == REPORT_HOUR && !reportSentToday) {
    sendDailyReport(s, t, h);
    reportSentToday = true;
  }
  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á 8 ‡πÇ‡∏°‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
  if (currentHour != REPORT_HOUR) {
    reportSentToday = false;
  }
  
  delay(10); 
}
